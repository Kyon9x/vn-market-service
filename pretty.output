Feature: Error Handling and Edge Cases # features/error_handling.feature:1
  As a system user
  I want appropriate error responses
  So that I can handle failures gracefully
  Feature: Error Handling and Edge Cases  # features/error_handling.feature:1

  @error-handling
  Scenario: Invalid symbol handling             # features/error_handling.feature:10
    Given the market data service is running    # features/steps/given_steps.py:6
    Given I request data for an invalid symbol  # features/steps/given_steps.py:57
    When I call the quote endpoint              # features/steps/when_steps.py:103
    Then I should receive a 404 error           # features/steps/then_steps.py:146
    And the error message should be descriptive # features/steps/then_steps.py:158

  @error-handling
  Scenario: Empty search query handling                   # features/error_handling.feature:17
    Given the market data service is running              # features/steps/given_steps.py:6
    Given I provide an empty search query                 # features/steps/given_steps.py:63
    When I call the search endpoint                       # features/steps/when_steps.py:109
    Then I should receive a validation error              # features/steps/then_steps.py:165
    And the error should indicate missing query parameter # features/steps/then_steps.py:174

  @error-handling
  Scenario: Invalid date range for history              # features/error_handling.feature:24
    Given the market data service is running            # features/steps/given_steps.py:6
    Given I request historical data with invalid dates  # features/steps/given_steps.py:69
    When I call the history endpoint                    # features/steps/when_steps.py:115
    Then I should receive a validation error            # features/steps/then_steps.py:165
    And the error should describe the date format issue # features/steps/then_steps.py:185

  @error-handling
  Scenario: Service unavailable simulation             # features/error_handling.feature:31
    Given the market data service is running           # features/steps/given_steps.py:6
    Given the external data source is unavailable      # features/steps/given_steps.py:76
    When I request market data                         # features/steps/when_steps.py:125
    Then I should receive appropriate error handling   # features/steps/then_steps.py:196
    And the response should indicate retry possibility # features/steps/then_steps.py:204

Feature: Market Data API Endpoints # features/market_data_api.feature:1
  As a Wealthfolio user
  I want to retrieve market data for Vietnamese assets
  So that I can view portfolio values and make investment decisions
  Feature: Market Data API Endpoints  # features/market_data_api.feature:1

  @smoke @stocks
  Scenario: Stock data retrieval workflow                # features/market_data_api.feature:11
    Given the market data service is running             # features/steps/given_steps.py:6
    And the service health check passes                  # features/steps/given_steps.py:14
    Given I search for stocks with a common symbol       # features/steps/given_steps.py:21
    When I select the first search result                # features/steps/when_steps.py:5
    And I request the latest quote for that symbol       # features/steps/when_steps.py:15
    Then I should receive valid quote data               # features/steps/then_steps.py:5
    And the quote should contain price information       # features/steps/then_steps.py:11
    When I request historical data for the past 365 days # features/steps/when_steps.py:21
    Then I should receive historical price records       # features/steps/then_steps.py:19
    And the history should contain multiple trading days # features/steps/then_steps.py:25
    And all data should be in VND currency               # features/steps/then_steps.py:34

  @smoke @funds
  Scenario: Fund data retrieval workflow                 # features/market_data_api.feature:23
    Given the market data service is running             # features/steps/given_steps.py:6
    And the service health check passes                  # features/steps/given_steps.py:14
    Given I search for mutual funds with a fund symbol   # features/steps/given_steps.py:28
    When I select the first search result                # features/steps/when_steps.py:5
    And I request the latest NAV for that fund           # features/steps/when_steps.py:27
    Then I should receive valid NAV data                 # features/steps/then_steps.py:43
    And the NAV should contain net asset value           # features/steps/then_steps.py:49
    When I request historical NAV data for the past year # features/steps/when_steps.py:33
    Then I should receive historical NAV records         # features/steps/then_steps.py:57
    And the history should show daily NAV values         # features/steps/then_steps.py:63

  @smoke @indices
  Scenario: Index data retrieval workflow       # features/market_data_api.feature:34
    Given the market data service is running    # features/steps/given_steps.py:6
    And the service health check passes         # features/steps/given_steps.py:14
    Given I search for market indices           # features/steps/given_steps.py:35
    When I select VNINDEX from the results      # features/steps/when_steps.py:39
    And I request the latest index value        # features/steps/when_steps.py:56
    Then I should receive valid index data      # features/steps/then_steps.py:72
    And the index should contain current points # features/steps/then_steps.py:78
    When I request historical index data        # features/steps/when_steps.py:62
    Then I should receive index history         # features/steps/then_steps.py:86
    And the data should show market trends      # features/steps/then_steps.py:92

  @smoke @gold
  Scenario: Gold price retrieval workflow          # features/market_data_api.feature:45
    Given the market data service is running       # features/steps/given_steps.py:6
    And the service health check passes            # features/steps/given_steps.py:14
    Given I search for gold prices                 # features/steps/given_steps.py:42
    When I select SJC gold from the results        # features/steps/when_steps.py:68
    And I request the latest gold price            # features/steps/when_steps.py:85
    Then I should receive valid gold price data    # features/steps/then_steps.py:101
    And the price should be in VND per tael        # features/steps/then_steps.py:107
    When I request historical gold prices          # features/steps/when_steps.py:91
    Then I should receive gold price history       # features/steps/then_steps.py:117
    And the history should show price fluctuations # features/steps/then_steps.py:123

  @regression
  Scenario Outline: Asset type data retrieval -- @1.1   # features/market_data_api.feature:64
    Given the market data service is running            # features/steps/given_steps.py:6
    And the service health check passes                 # features/steps/given_steps.py:14
    Given I search for stocks with symbol VNM           # features/steps/given_steps.py:49
    When I request the latest quote                     # features/steps/when_steps.py:97
    Then I should receive valid stocks data             # features/steps/then_steps.py:132
    And the data should not be empty                    # features/steps/then_steps.py:138

  @regression
  Scenario Outline: Asset type data retrieval -- @1.2   # features/market_data_api.feature:65
    Given the market data service is running            # features/steps/given_steps.py:6
    And the service health check passes                 # features/steps/given_steps.py:14
    Given I search for funds with symbol VFMVF1         # features/steps/given_steps.py:49
    When I request the latest quote                     # features/steps/when_steps.py:97
    Then I should receive valid funds data              # features/steps/then_steps.py:132
    And the data should not be empty                    # features/steps/then_steps.py:138

  @regression
  Scenario Outline: Asset type data retrieval -- @1.3   # features/market_data_api.feature:66
    Given the market data service is running            # features/steps/given_steps.py:6
    And the service health check passes                 # features/steps/given_steps.py:14
    Given I search for indices with symbol VNINDEX      # features/steps/given_steps.py:49
    When I request the latest quote                     # features/steps/when_steps.py:97
    Then I should receive valid indices data            # features/steps/then_steps.py:132
    And the data should not be empty                    # features/steps/then_steps.py:138

  @regression
  Scenario Outline: Asset type data retrieval -- @1.4   # features/market_data_api.feature:67
    Given the market data service is running            # features/steps/given_steps.py:6
    And the service health check passes                 # features/steps/given_steps.py:14
    Given I search for gold with symbol SJC             # features/steps/given_steps.py:49
    When I request the latest quote                     # features/steps/when_steps.py:97
    Then I should receive valid gold data               # features/steps/then_steps.py:132
    And the data should not be empty                    # features/steps/then_steps.py:138

